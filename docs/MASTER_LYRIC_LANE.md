# Master Lyric Lane Feature

A dedicated timeline lane that displays lyrics from all vocal tracks with real-time karaoke highlighting and multi-speaker visual distinction.

## Features

### Visual Design
- **Position**: Located at the bottom of the timeline, right above the timeline footer
- **Beat-Snapped Chips**: Each word appears as a rounded chip positioned according to its beat timing
- **Multi-Speaker Coloring**:
  - **Lead Vocals**: Solid purple fill (`rgba(158, 127, 255, 0.9)`)
  - **Harmony Vocals**: Pink outline style (`rgba(244, 114, 182, 1)` border)
  - **Choir Vocals**: Striped green pattern (repeating diagonal stripes)

### Interactive Features
- **Karaoke Highlighting**: Current playhead word gets bold yellow highlight with animated sweep
- **Click to Seek**: Click any word chip to jump to that position in the timeline
- **Scroll Sync**: Lyric lane scrolls in sync with the main timeline
- **Track Selection**: Dropdown to choose which vocal tracks to display:
  - "All Vocals (Merged)" - Shows all vocal tracks combined
  - "Lead Only" - Shows only lead vocal tracks
  - Individual track selection by name

### Data Processing
- **Auto-Follow**: Automatically detects and processes vocal tracks (`category: 'vocal'` or `type: 'lyrics'`)
- **Word Extraction**: Splits lyric text into individual words for chip display
- **Beat Mapping**: Calculates word positions based on timing and song tempo
- **Extended Structure Support**: 
  - Handles both legacy lyrics format and new extended structure
  - Supports syllables breakdown with note mapping
  - Includes IPA phonemes for TTS/singing engines
  - References song sections (sectionId, sectionSpans)

## Implementation Details

### New Interface Extensions
```typescript
interface SyllableBreakdown {
  t: string        // syllable text
  noteIdx: number[] // note indices this syllable maps to
  dur: number      // duration of this syllable
  melisma?: boolean // if this syllable spans multiple notes
}

interface LyricFragment {
  text: string
  notes: string[]
  start: number
  duration?: number
  durations?: number[]
  // Extended structure
  syllables?: SyllableBreakdown[]
  phonemes?: string[] // IPA phonemes for TTS/singing engines
}

interface AudioClip {
  // ... existing fields
  sectionId?: string // Reference to song structure section
  sectionSpans?: string[] // Sections this clip spans
}
```

### Master Lyric Word Structure
```typescript
interface MasterLyricWord {
  text: string
  startTime: number
  duration: number
  endTime: number
  trackId: string
  clipId: string
  voiceId: string
  speakerType: 'lead' | 'harmony' | 'choir'
  beatPosition: number
  originalLyric: LyricFragment
}
```

## Usage

### Testing the Feature
1. Load a song with vocal tracks in the timeline
2. Click "üìù Add Test Vocals" button to add sample vocal tracks for testing
3. The master lyric lane will appear at the bottom showing word chips
4. Use the dropdown to switch between different vocal track views
5. Click word chips to seek to specific positions
6. Play the song to see karaoke highlighting

### Integration with LangChain Agents
The master lyric lane automatically works with songs generated by the LangChain vocal and lyrics agents, which now include:
- Syllables breakdown with note mapping
- IPA phonemes for accurate pronunciation
- Section references for proper song structure integration
- Multi-voice support with speaker type detection

## Styling

The master lyric lane uses CSS custom properties and is fully responsive:
- Syncs with timeline zoom levels
- Maintains proper aspect ratios at different zoom levels  
- Uses consistent color scheme with the rest of the application
- Smooth animations for karaoke highlighting and interactions

## Future Enhancements

1. **Live Recording**: Show real-time lyrics as they're being recorded
2. **Harmony Visualization**: Enhanced display of harmonic relationships
3. **Phoneme Display**: Toggle to show IPA phonemes instead of text
4. **Section Markers**: Visual indicators for song structure sections
5. **Export Options**: Export lyrics as SRT subtitles or other formats
